(self.webpackChunk=self.webpackChunk||[]).push([[4382],{73310:(e,t,i)=>{i.r(t),i.d(t,{CheetahFeatureImpl:()=>ot,isAssistantOpened:()=>at});var s=i(17771),n=i(17889),a=i(62965),o=i(6294),r=i(85892),l=i(57050),c=i(27378),d=i(54696),h=i(55649),u=i(98805),p=i(14601),m=i(32952),g=i(60797),v=i(66310),_=i(24209),b=i(85985),S=i(23063),f=i(40151),w=i(98403),y=i(2844),R=i(77176),I=i(2834),C=i(76974),E=i(28043),x=i(41398),A=i(93508),U=i(16118),k=i(13444),B=i(78674),P=i(17343),M=i(80544),T=i(79692),N=i(67434),O=i(19751),G=i(44586),H=i(97425),F=i(5114),D=i(8125),z=i(83078),q=i(22232),W=i(95195),V=i(12187),L=i(38983),Z=i(56370),j=i(51325);const Q=({width:e,height:t,top:i,left:s,visibility:n})=>c.createElement("div",{"data-grammarly-part":"cheetah-highlight-rect",...(0,V.Sh)(j.highlightRect,"hidden"===n?j.hidden:null,"attention"===n?j.attention:null),style:{width:e,height:t,top:i,left:s}});var Y=i(6726),K=i(16805);const X=c.forwardRef((function({forceTooltipMessage:e,onClick:t,onMouseEnter:i,onMouseLeave:s},n){return c.createElement(Y.u,{message:"Open GrammarlyGO",forcedMessage:e},c.createElement("button",{onClick:t,"data-grammarly-part":"cheetah-ideate-button",className:K.ideateButton,ref:n,onMouseEnter:i,onMouseLeave:s},c.createElement("div",{className:K.ideateButtonIcon})))}));var $=i(864),J=i(88571),ee=i(4147),te=i(89894),ie=i(33678),se=i(15073),ne=i(42103),ae=i(51369),oe=i(85665);const re=te.ux.style({fontStyle:"normal",fontWeight:"normal",fontFamily:"Inter, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', sans-serif, Arial",$nest:{"button, input, textarea":{fontFamily:"inherit"}}}),le=({isMac:e,children:t})=>{var i;const s=null===(i=c.useContext(oe.nS.Context))||void 0===i?void 0:i.host,n=c.useMemo((()=>new $.C(e)),[e]);return c.createElement(ee.o,null,c.createElement(ie.a.Context.Provider,{value:n},c.createElement(J.Q,{remSize:C.of(16),setter:e=>se.u.setRootCssVar(s||document.documentElement,e)},c.createElement(ne.G.DefaultProvider,null,c.createElement("div",{className:re},t,c.createElement(ae.X,null))))))};var ce=i(74204),de=i(50783);const he=({referenceElement:e,placement:t,offset:i,disabled:s,onClick:n})=>{const[a,o]=c.useState(null),{styles:r,attributes:l}=(0,ce.D)(e,a,{placement:t,modifiers:i?[{name:"offset",options:{offset:i}}]:[]});return c.createElement("button",{ref:o,style:r.popper,...l.popper,onClick:n,onMouseDown:e=>{e.stopPropagation(),e.preventDefault()},"data-grammarly-part":"cheetah-reply-button",className:de.replyButton,"data-disabled":s},c.createElement("div",{className:de.icon}),c.createElement("span",null,"Reply quickly"))};var ue=i(87491);const pe=({referenceElement:e,placement:t,offset:i,disabled:s,onMagicRewriteClick:n,onOpenRewriteClick:a})=>{const[o,r]=c.useState(null),{styles:l,attributes:d}=(0,ce.D)(e,o,{placement:t,modifiers:i?[{name:"offset",options:{offset:i}}]:[]});return n||a?c.createElement("div",{ref:r,style:l.popper,...d.popper,onMouseDown:e=>{e.stopPropagation(),e.preventDefault()},"data-grammarly-part":"cheetah-entry-button",className:ue.entryButton,"data-disabled":s},n?c.createElement(Y.u,{message:"Improve it"},c.createElement("button",{onClick:n,onMouseDown:e=>{e.stopPropagation(),e.preventDefault()},className:ue.entryButtonItem,"data-disabled":s},c.createElement("i",{className:ue.rewriteIcon}))):null,a?c.createElement(Y.u,{message:"Open GrammarlyGO"},c.createElement("button",{onClick:a,onMouseDown:e=>{e.stopPropagation(),e.preventDefault()},className:ue.entryButtonItem,"data-disabled":s},c.createElement("i",{className:ue.openIcon}))):null):null};var me=i(90845),ge=i(49708),ve=i(5739),_e=i(48033);const be=()=>c.createElement("svg",{className:_e.icon,viewBox:"0 0 16 16",fillRule:"evenodd",clipRule:"evenodd",strokeLinecap:"round"},c.createElement("path",{d:"M8,16C12.418,16 16,12.418 16,8C16,3.582 12.418,0 8,0C3.582,0 0,3.582 0,8C0,12.418 3.582,16 8,16Z",fill:"#0A9A78"}),c.createElement("path",{d:"M4,8L12,8M8,4L8,12",fill:"none",fillRule:"nonzero",stroke:"white",strokeWidth:"1.5px"})),Se=({overflow:e,...t})=>e?c.createElement(we,{...t}):c.createElement(fe,{...t}),fe=({left:e,top:t,height:i})=>c.createElement(c.Fragment,null,c.createElement("div",{"data-grammarly-part":"cheetah-quasi-caret",className:_e.quasiCaret,style:{left:e,top:t+i,height:i+8}},c.createElement(be,null))),we=({left:e,top:t,height:i})=>{const{ref:n,onMount:a}=me.P.useElWatcher(),o=c.useMemo((()=>L.h.create(F.none)),[]),{rect:r,onMount:d}=me.P.useRectWatcher(),h=c.useCallback((e=>{e.style.pointerEvents="all",o.set((0,l.zG)(s.Y(F.option)({rect:F.some(e.getBoundingClientRect()),goodParent:(0,l.zG)(e.getBoundingClientRect(),(e=>({x:e.x+e.width/2,y:e.y+e.height/2})),(({x:e,y:t})=>{var i,s;return F.fromNullable(null===(s=null===(i=document.elementFromPoint(e,t))||void 0===i?void 0:i.shadowRoot)||void 0===s?void 0:s.elementFromPoint(e,t))}),F.filter((t=>t===e||e.contains(t||null))))}),F.fold((()=>F.none),(({rect:e})=>F.some({x:e.x,y:e.y}))))),e.style.pointerEvents="none"}),[]),u=c.useMemo((()=>ge.R(document,"scroll",{capture:!0}).pipe(A.O(null))),[]);return me.P.useSubscriptionTo(y.aj([n.pipe(g.oA),u,r]).pipe(I.b((([e])=>h(e))))),c.createElement(c.Fragment,null,c.createElement("div",{"data-grammarly-part":"cheetah-quasi-caret",className:_e.quasiCaret,style:{left:e,top:t+i,height:i+8},ref:e=>{a(e),d(e)}},c.createElement(ve.F.div,{style:o.pipe(R.U((e=>(0,l.zG)(e,F.fold((()=>({opacity:1})),(()=>({opacity:0})))))))},c.createElement(be,null))),c.createElement(ve.F.Fragment,null,o.pipe(R.U((e=>(0,l.zG)(e,F.fold(l.gn,(e=>c.createElement("div",{"data-grammarly-part":"cheetah-quasi-caret-fixed-bro",className:_e.quasiCaret,style:{transform:"none",position:"fixed",left:e.x,top:e.y,height:i+8}},c.createElement(be,null))))))))))};var ye=i(10389),Re=i(64015),Ie=i(89766),Ce=i(97834),Ee=i(85612),xe=i(9137),Ae=i(13287),Ue=i(36582),ke=i(9023),Be=i(9295),Pe=i(8887),Me=i(95010),Te=i(15021),Ne=i(34795),Oe=i(47388),Ge=i(37306),He=i(1186),Fe=i(41458),De=i(18695),ze=i(33647),qe=i(51129),We=i(7534);var Ve=i(44358),Le=i(81873),Ze=i(81531),je=i(65504),Qe=i(9205),Ye=i(9629),Ke=i(88355),Xe=i(62074),$e=i(30857);function Je(e){var t,i,s,n,a,o,r,c,d,h,u,p,m,g,v,_,b;const S=e=>{var t;return null!==(t=null==e?void 0:e.reduce(((e,t)=>{var i;return t.email&&!e.has(t.email)&&e.set(t.email,{name:null!==(i=t.name)&&void 0!==i?i:"",email:t.email}),e}),new Map))&&void 0!==t?t:new Map},f=S(null===(s=null===(i=null===(t=e.parents)||void 0===t?void 0:t[0])||void 0===i?void 0:i.audience)||void 0===s?void 0:s.indirectRecipients),w=S(null===(o=null===(a=null===(n=e.parents)||void 0===n?void 0:n[0])||void 0===a?void 0:a.audience)||void 0===o?void 0:o.undisclosedRecipients),y=S(null===(h=null===(d=null===(c=null===(r=e.parents)||void 0===r?void 0:r[0])||void 0===c?void 0:c.audience)||void 0===d?void 0:d.recipients)||void 0===h?void 0:h.filter((({email:e})=>(0,$e.HD)(e)&&!f.has(e)&&!w.has(e)))),R=S(null===(u=e.audience)||void 0===u?void 0:u.indirectRecipients),I=S(null===(p=e.audience)||void 0===p?void 0:p.undisclosedRecipients),C=S(null===(g=null===(m=e.audience)||void 0===m?void 0:m.recipients)||void 0===g?void 0:g.filter((({email:e})=>(0,$e.HD)(e)&&!R.has(e)&&!I.has(e))));return{previousMessageInfo:(0,l.zG)(Re.YM(null!==(v=e.parents)&&void 0!==v?v:[]),F.fold((()=>Xe.H3.PreviousMessageInfo.empty),(e=>{var t;return{author:(0,l.zG)(Re.YM(null!==(t=e.authors)&&void 0!==t?t:[]),F.fold((()=>Xe.H3.Person.empty),(e=>{var t,i;return{name:null!==(t=e.name)&&void 0!==t?t:"",email:null!==(i=e.email)&&void 0!==i?i:""}}))),directRecipients:Array.from(y.values()),text:e.delta?(0,Ke.l)(e.delta,""):""}}))),title:null!==(_=e.title)&&void 0!==_?_:"",author:(0,l.zG)(Re.YM(null!==(b=e.authors)&&void 0!==b?b:[]),F.fold((()=>Xe.H3.Person.empty),(e=>{var t,i;return{name:null!==(t=e.name)&&void 0!==t?t:"",email:null!==(i=e.email)&&void 0!==i?i:""}}))),directRecipients:Array.from(C.values()),indirectRecipients:Array.from(R.values()),undisclosedRecipients:Array.from(I.values())}}var et=i(21878);function tt(e){return Promise.resolve().then(i.bind(i,21878)).then((({createRevisionEngine:t})=>{const i=h.Y.create("cheetah.revision"),{revisionEngine:s,dispose:n}=t({capiService:e.capiService,sduiService:{sduiItemCollectionChanges:f.E},alertService:{alertCollectionChanges:f.E,selectedAlertId:L.h.create(F.none),applyAlerts:e=>a.of(void 0),removeAlerts:e=>a.of(void 0),setAlertsVisibility:e=>a.of(void 0),updateAlertsVisibility:e=>a.of(void 0)},monitoringService:{notify:t=>function(e,t,i,s){(0,et.isRevisionMonitoringEventError)(t)?e.cheetah.error(t,i,s):(0,et.isRevisionMonitoringEventWarning)(t)?e.cheetah.warning(t,i,s):(0,et.isRevisionMonitoringEventInfo)(t)?e.cheetah.info(t,i,s):(0,q.L0)(t)}(e.telemetry,t,e.domain,e.getSessionUuid())},logger:i});return{revisionEngine:s,dispose:n}}))}const it=(0,V.xb)(X),st=new Set(["onboarding","gdocsOnboardingPopup","loginSSO","accountMigration","standWithUkraineGrammarlySuspended","claimedUser","dataControl","noPaymentMethodSubscription","grammarlyBusinessSigninPopup","gdocsFeedbackUI"]),nt=new Set(["onboarding","gdocsOnboardingPopup","loginSSO","accountMigration","standWithUkraineGrammarlySuspended","claimedUser","dataControl","grammarlyBusinessSigninPopup"]),at=e=>"opened"===e.kind;class ot{constructor(e){this._params=e,this._subs=new p.w,this._log=h.Y.create("CheetahFeatureImpl"),this._inlineButtonUI=L.h.create(null),this._ideateButtonUI=L.h.create(null),this._expandedIdeateButtonUI=L.h.create(null),this._assistantUI=L.h.create(null),this._highlightUI=L.h.create(null),this._quasiCaretUI=L.h.create(null),this._onboardingUI=L.h.create(null),this._nativeCursorHider=L.h.create(F.none),this._lastRestartAttemptTime=L.h.create(0),this._contextHighlight=L.h.create(F.none),this.inlineButtonUI=this._inlineButtonUI.view(),this.ideateButtonUI=this._ideateButtonUI.view(),this.expandedIdeateButtonUI=this._expandedIdeateButtonUI.view(),this.assistantUI=this._assistantUI.view(),this.highlightUI=this._highlightUI.view(),this.quasiCaretUI=this._quasiCaretUI.view(),this.onboardingUI=this._onboardingUI.view(),this._ideateButtonTooltipNotificationState=L.h.create(F.none),this._assistantFocused=L.h.create(!1),this._inlineButtonRecentlyPressed=L.h.create(!1),this._ideateButtonRecentlyHovered=L.h.create(!1),this._selectionRange=L.h.create(F.none),this._highlights=L.h.create([]),this._quasiCaretRect=L.h.create(F.none),this._assistantSession=L.h.create(F.none),this._onboardingViewModel=L.h.create(F.none),this._ideateButtonRefChange=new m.xQ,this._disposed=new m.xQ,this._initialOnboardingBlockedForSession=L.h.create(!1),this.sessionState=this._assistantSession.view(F.fold((()=>({kind:"closed"})),(()=>({kind:"opened",shouldHideAllAlerts:!1===this._params.mergedCheetahEnabled})))),this._cheetahServices=function(e,t,i,s,n,r,c,d,h,u,g,_,f,w,E,x,A,U,k,B,P,D,z,V,Z,j){const Q=new m.xQ,Y=()=>(0,l.zG)(e.get(),W.fromOption((()=>new Error("checking service not initialized")))),K=new Ae.t({inboundCAPIMessages:t,sendCAPIMessage:({action:e,data:t,shouldInjectRev:i,shouldInjectSessionId:s})=>(0,l.zG)(Y(),a.Uo,a.tS((n=>n.sendMessage(e,t,i,s))))}),X=new xe.c(K),$={user:L.h.combine(i,s,((e,t)=>({id:Fe.n.Id.create(e.id),isPremium:qe.n5.isPremium(e),dialect:t}))),setDialect:n},J=new Ie.L(K,d.view((0,l.ls)(F.chain((e=>F.fromNullable(e.cheetahState))),F.fold((()=>({enabled:!1})),(e=>({enabled:!0,userState:e})))))),ee=r.pipe(v.w(F.fold((()=>C.of(F.none)),(e=>e.sessionService.session.view(F.some))))),te=h.pipe(M.QV(T.E),N.R(((e,t)=>{const i=e.filter(lt);return t&&lt(t)?[...i,t]:i}),[]),R.U(Re.Z$),O.shareReplay({bufferSize:1,refCount:!0})),ie=y.aj([te,u,g]).pipe(R.U((([e,t,i])=>(0,l.zG)(e,F.filter((()=>t)),F.fold((()=>({})),(e=>({[Ne.n.initialPopupAnchor]:i?{reference:e,placement:"top",offset:8,boundaryAreaPadding:10}:void 0,[Ne.n.initialBTSPopupAnchor]:i?{reference:e,placement:"top",offset:8,boundaryAreaPadding:10}:void 0,[Ne.n.rewriteTooltipAnchor]:{reference:e,placement:"top",offset:8,boundaryAreaPadding:10}}))))))),se=r.pipe(v.w(F.fold((()=>C.of(!1)),(e=>e.viewModels.position.state.view((e=>"dragged"===e.kind&&e.dragging)))))),ne=e=>{null==j||j.debug(`Completing step [${e}]`);f.get()[e].extension.completed||w({[e]:{completed:!0,lastSeen:Date.now()}})},ae=()=>{const e=new Set;E.get().rewrite&&x||e.add(Oe.T.StepName.rewrite),E.get().compose||e.add(Oe.T.StepName.initial),E.get().onboarding||(e.add(Oe.T.StepName.initial),e.add(Oe.T.StepName.initialBTS),e.add(Oe.T.StepName.rewrite),e.add(Oe.T.StepName.prompts),e.add(Oe.T.StepName.review),e.add(Oe.T.StepName.knowledgeHub),e.add(Oe.T.StepName.references));const t=(0,l.zG)(d.get(),F.map((e=>"ASSIGNMENT_WRITING"===e.defaultDocumentContext.writingIntent)),F.getOrElse(l.jv));return E.get().onboardingBTS&&t||e.add(Oe.T.StepName.initialBTS),E.get().knowledgeHubIntegration||e.add(Oe.T.StepName.knowledgeHub),(0,ze.kF)({upstreamOnboardingState:f,session:ee,textStats:c,forceDisabledOnboardingSteps:e,assistantUIActions:Q,externalElements:ie,hideAssistantOnboardingTooltips:se,promptsAllocated:J.availability.view(Te._.getPromptsAllocated),client:"extension",trackingService:X,disposed:_,logger:Ze.C8.Logging.getLogger("OnboardingCompletionEffects"),completeOnboardingStep:ne})},oe={reportUphookShow:e=>a.tD((()=>{e.isPremium||((0,Ve.n)(z,{placement:"grammarlyGoPrompts",upgradeHookName:"grammarlyGoPrompts",upgradeHookSlot:"grammarlyGo"}),Z.upgradeHooks.showUpgradeHook("grammarlyGoPrompts","grammarlyGo"))})),reportUphookClick:e=>a.tD((()=>{e.isPremium?self.open(o.Rd().appConfig.url.support):((0,Ve.Q)(z,{placement:"grammarlyGoPrompts",upgradeHookName:"grammarlyGoPrompts",upgradeHookSlot:"grammarlyGo"}),Z.upgradeHooks.clickUpgradeHook("grammarlyGoPrompts","grammarlyGo"),(0,We.wW)("upHook","grammarlyGoPrompts"))}))};return{capiService:K,userService:$,genAIAvailabilityService:J,trackingService:X,textEditorService:{flush:()=>a.fF((()=>new G.y((t=>{const i=new p.w;return A.empty.get()?t.next(void 0):(A.flush(),(0,l.zG)(e.get(),F.fold((()=>t.next(void 0)),(e=>{i.add(e.messages.pipe(b.h((e=>e._tag===ye.J8.Type.submitOtAck)),H.L(500,C.of(null)),I.b((()=>t.next(void 0)))).subscribe())})))),()=>i.unsubscribe()})).pipe(S.q(1)).toPromise())),getText:e=>a.tD((()=>U(e))),insertText:e=>a.tD((()=>k(e))),setContextHighlight:(e,t)=>{D.set(F.some({range:e,visibility:t}))},selectedRange:B,textUpdated:P},feedbackService:{submitFeedback:e=>a.Y3((()=>(0,l.zG)(e.source,(e=>e===Ge.x.Source.resultCard?"cheetah-card":e===Ge.x.Source.quickReplyInitialActions?"cheetah-quick-reply":void(0,q.L0)(e)),(t=>z.feedbackFormSubmit(e.mood,t,e.domain,e.message)))),(e=>new Error(String(e))))},uphookService:oe,createOnboardingViewModel:ae,notifyAssistantUIAction:e=>Q.next(e),dispose:()=>J.dispose()}}(this._params.checkingService,this._params.checkingService.pipe(g.oA,v.w((e=>e.capiMessages))),this._params.user,this._params.dapiSettings.view((e=>e.dialectStrong?Be.L.Dialect.Value.fromString(e.dialectStrong):e.dialectWeak?Be.L.Dialect.Value.fromString(e.dialectWeak):Be.L.Dialect.Value.american)),(e=>a.fF((()=>this._params.dapiActions.changeStrongDialect(e)))),this._assistantSession,this._params.textStats,this._params.capiStartAckMessage,this._ideateButtonRefChange,L.h.combine(this._params.integration.canShowIdeateButtonPopups,this._params.gButtonPopupState.view("type").view((e=>!st.has(e))),D.xD),L.h.combine(this._params.csPageState.view("cheetah").view((e=>(null==e?void 0:e.canShowInitialOnboarding)||(null==e?void 0:e.canShowInitialBTSOnboarding)||!1)),this._initialOnboardingBlockedForSession,((e,t)=>e&&!t)),_.T(this._params.csPageState.view("isActiveTab").pipe(b.h((e=>!e))),this._disposed).pipe(S.q(1)),this._params.dapiSettings.view((e=>function(e){const t=Me.Z.State.toClientState(Me.Z.decode(e.extension||""),"extension"),i=Me.Z.State.toClientState(Me.Z.decode(e.editor||""),"editor"),s=Me.Z.State.toClientState(Me.Z.decode(e.llamaMac||""),"llamaMac"),n=Me.Z.State.toClientState(Me.Z.decode(e.llamaWindows||""),"llamaWin");return(0,l.zG)(Me.Z.State.empty,Me.Z.State.patch(t,"extension"),Me.Z.State.patch(i,"editor"),Me.Z.State.patch(s,"llamaMac"),Me.Z.State.patch(n,"llamaWin"))}({extension:e["cheetah:onboardingState"],editor:e["cheetah:onboardingState:editor"],llamaMac:e["cheetah:onboardingState:llamaMac"],llamaWindows:e["cheetah:onboardingState:llamaWindows"]}))),(e=>{this._params.dapiActions.modifyCheetahOnboardingState((0,l.ls)(Me.Z.decode,(t=>(0,l.zG)(Me.Z.State.toClientState(t,"extension"),(t=>({...t,...e})),(e=>Me.Z.State.patch(e,"extension")(t)))),Me.Z.encode))}),this._params.featureFlags,this._params.integration.enableInlineRewrites,this._params.textChangeBuffer,(e=>this._params.integration.getText(e)),(e=>this._insertText(e)),this._selectionRange,this._params.integration.textUpdated,this._contextHighlight,this._params.gnar,this._params.mergedCheetahEnabled,this._params.telemetry,this._log),this._isOnboardingPopupVisible=L.h.create(!1),this._entryPointsEnabled=L.h.create(!1),this.isOnboardingPopupVisible=this._isOnboardingPopupVisible.view(),this.isAvailable=L.h.combine(this._cheetahServices.genAIAvailabilityService.availability.view((0,D.ff)(Te._.isUnavailable)),this._params.csPageState.view("cheetah"),((e,t)=>{var i;return e&&!0===(null===(i=null==t?void 0:t.status)||void 0===i?void 0:i.cheetahEnabled)})),this.userSettings=this._cheetahServices.genAIAvailabilityService.availability.view("userSettings"),this._params.dapiActions.reloadPropsRateLimited(),this._subs.add(this._params.checkingService.pipe(g.oA,v.w((e=>e.readyState)),b.h((e=>e===ye.kQ.ready)),S.q(1)).subscribe((()=>this._init()))),this._subs.add(this._listenToMonitoringEvents(this._params.telemetry)),this._subs.add(this._setupIdeateTooltipStateObs());const t=this._onboardingViewModel.pipe(v.w(F.fold((()=>f.E),(e=>e.uiActions))));this._subs.add(t.pipe(b.h(dt)).subscribe((()=>{this._params.cheetahCSActions.cheetahInitialOnboardingShown()}))),this._subs.add(t.pipe(b.h(ht)).subscribe((()=>{this._params.cheetahCSActions.cheetahInitialBTSOnboardingShown()}))),this._subs.add(this._getOnboardingVMStepActive([Oe.T.StepName.initial,Oe.T.StepName.initialBTS]).subscribe(w.wW(this._isOnboardingPopupVisible))),this._subs.add(this._params.gButtonPopupState.view("type").view((e=>nt.has(e))).subscribe((e=>{e&&this._initialOnboardingBlockedForSession.set(!0)}))),this._subs.add(y.aj([this._params.gButtonDisabledReason,this._params.integration.entryPointsEnabled]).pipe(R.U((([e,t])=>t&&!function(e){const t=new Set([je.P.DATA_CONTROL_ACTIVE,je.P.OFFLINE,je.P.STAND_WITH_UKRAINE,je.P.USER_CLAIMED,je.P.USER_EDC_BLOCKED,je.P.SIGNED_OUT_GB]);return null!==e&&t.has(e)}(e)))).subscribe(w.wW(this._entryPointsEnabled))),this._subs.add(this._params.csPageState.view("cheetah").view((e=>{var t;return!1===(null===(t=null==e?void 0:e.status)||void 0===t?void 0:t.cheetahEnabled)})).subscribe((()=>this._terminateAssistantSession(Le.R.disposed)))),this._subs.add(this._params.startNewSessionEvents.subscribe((e=>{this._startNewAssistantSession(e)}))),this._registerDebugHelpers()}closeAssistant(e){this._terminateAssistantSession(e)}_init(){this._subs.add(this._assistantFocused.subscribe((e=>this._log.debug("Assistant "+(e?"focused":"blurred"))))),this._subs.add(this._getInlineButtonUI().subscribe(w.wW(this._inlineButtonUI))),this._subs.add(this._getIdeateButtonUI().subscribe(w.wW(this._ideateButtonUI))),this._subs.add(this._getExpandedIdeateButtonUI().subscribe(w.wW(this._expandedIdeateButtonUI))),this._subs.add(this._getAssistantUI().subscribe(w.wW(this._assistantUI))),this._subs.add(this._getHighlightUI().subscribe(w.wW(this._highlightUI))),this._subs.add(this._getQuasiCaretUI().subscribe(w.wW(this._quasiCaretUI))),this._subs.add(this._getOnboardingUI().subscribe(w.wW(this._onboardingUI))),this._subs.add(this._updateSelectionRange().subscribe(w.wW(this._selectionRange))),this._subs.add(this._updateHighlightRects().subscribe(w.wW(this._highlights))),this._subs.add(this._updateQuasiCaretRect().subscribe(w.wW(this._quasiCaretRect))),this._subs.add(this._updateNativeCursor().subscribe()),this._subs.add(this._closeRewriteAssistantWhenUnfocused().subscribe()),this._subs.add(this._assistantSession.view(F.isSome).subscribe((e=>{e&&this._params.closeGrammarlyAssistant()}))),this._subs.add(this._createOnboardingViewModelWhenCheetahAvailable().subscribe()),this._subs.add(this._handleTryItOut().subscribe())}_handleTryItOut(){return this._onboardingViewModel.pipe(v.w(F.fold((()=>f.E),(e=>e.uiActions))),b.h(Pe.l.is(Pe.l.Kind.tryItOut)),I.b((()=>this._params.startNewSessionEvents.next({mode:rt(this._params.integration.quickReplyContext.get())&&this._params.featureFlags.get().quickReply?ke.wR.quickReply:ke.wR.ideation}))))}_getOnboardingVMStepActive(e){return this._onboardingViewModel.pipe(v.w(F.fold((()=>C.of(!1)),(t=>t.activeStep.view((0,l.ls)(F.filter((e=>e.show)),F.map((t=>e.includes(t.name))),F.getOrElse(l.jv)))))),E.x())}_listenToMonitoringEvents(e){return Ce.g.getInstance().events.pipe(x.M(this._params.checkingService)).subscribe((([t,i])=>{this._log.info("received monitoring event",{ev:t}),(0,l.zG)(i,z.tap((i=>{(0,He.YP)(t)?(e.cheetah.error(t,this._params.domain,i.sessionUuid),"waitForContextTimeout"!==t.name&&"waitForAckTimeout"!==t.name||"getContext"!==t.sourceCommand||(Date.now()-this._lastRestartAttemptTime.get()>u.LK(5)?(this._lastRestartAttemptTime.set(Date.now()),this._restartSession()):(0,l.zG)(t.name,(e=>"waitForAckTimeout"===e?"ack":"waitForContextTimeout"===e?"setContext":void(0,q.L0)(e)),(t=>e.cheetah.sessionRestartTimeout(t,this._params.domain,i.sessionUuid))))):(0,He.iu)(t)?e.cheetah.info(t,this._params.domain,i.sessionUuid):(0,He.DT)(t)?e.cheetah.warning(t,this._params.domain,i.sessionUuid):(0,q.L0)(t)})))}))}_setupIdeateTooltipStateObs(){return this._cheetahServices.genAIAvailabilityService.availability.pipe(A.O(null),U.G(),R.U((([e,t])=>e&&t&&Te._.isPassive(e)&&Te._.isActive(t)?F.some("Youâ€™ve got prompts!"):F.none)),v.w(F.fold((()=>C.of(F.none)),(e=>_.T(C.of(F.some(e)),C.of(F.none).pipe(k.g(3e3))))))).subscribe(w.wW(this._ideateButtonTooltipNotificationState))}_registerDebugHelpers(){!function(e){const t=self;t&&(t.cheetahDebug=t.cheetahDebug||{},Object.assign(t.cheetahDebug,e))}({clearOnboarding:()=>this._params.dapiActions.modifyCheetahOnboardingState((()=>Me.Z.encode(Me.Z.State.empty)))})}_createOnboardingViewModelWhenCheetahAvailable(){return L.h.combine(this._params.featureFlags,this._cheetahServices.genAIAvailabilityService.availability.view(Te._.isUsable),((e,t)=>e.onboarding&&t)).pipe(I.b((e=>this._onboardingViewModel.modify((t=>((0,l.zG)(t,z.tap((e=>e.dispose()))),e?F.some(this._cheetahServices.createOnboardingViewModel()):F.none))))))}_closeRewriteAssistantWhenUnfocused(){return this._assistantFocused.pipe(B.b(100),b.h((e=>!e&&(0,l.zG)(this._assistantSession.get(),F.fold(l.jv,(e=>e.sessionService.session.view((e=>"started"===e.kind&&ke.wR.isRewriteOrQuickRewrite(e.mode)&&F.isNone(e.inProgressResult)&&0===e.results.length)).get()))))),I.b((()=>this._terminateAssistantSession(Le.R.assistantBlurred))))}_onClickIdeateButton(e){F.isSome(this._assistantSession.get())?this._terminateAssistantSession(Le.R.closed):this._params.startNewSessionEvents.next({mode:e})}_updateSelectionRange(){return y.aj([this._params.integration.selectionRange,this._assistantUI.pipe(b.h((e=>null===e)))]).pipe(R.U((([e,t])=>({selectionRange:e,assistantIsFocused:this._assistantFocused.get(),inlineButtonRecentlyPressed:this._inlineButtonRecentlyPressed.get(),ideateButtonRecentlyHovered:this._ideateButtonRecentlyHovered.get(),initialPopupOnboardingStepIsActive:this.isOnboardingPopupVisible.get(),assistantIsHidden:t}))),I.b((({inlineButtonRecentlyPressed:e,ideateButtonRecentlyHovered:t})=>{e&&this._inlineButtonRecentlyPressed.set(!1),t&&this._ideateButtonRecentlyHovered.set(!1)})),b.h((({selectionRange:e,assistantIsFocused:t,inlineButtonRecentlyPressed:i,ideateButtonRecentlyHovered:s,initialPopupOnboardingStepIsActive:n,assistantIsHidden:a})=>!!a||!i&&!s&&(!F.isNone(e)||!t&&!n))),R.U((({selectionRange:e})=>e)))}_updateHighlightRects(){return e=this._selectionRange,t=this._contextHighlight,i=this._params.integration,y.aj([e.pipe(v.w(F.fold((()=>C.of([])),(e=>i.getHighlightRects(e).pipe(R.U((e=>e.map((e=>({rect:e,visibility:"visible"})))))))))),t.pipe(v.w(F.fold((()=>C.of([])),(e=>i.getHighlightRects(e.range).pipe(R.U((t=>t.map((t=>({rect:t,visibility:e.visibility}))))))))))]).pipe(R.U((([e,t])=>t.find((e=>"hidden"!==e.visibility))?t:e)));var e,t,i}_updateQuasiCaretRect(){return this._selectionRange.pipe(v.w((e=>(0,l.zG)(e,F.filter(d.SV.isCollapsed),F.fold((()=>C.of([])),(e=>this._params.integration.getHighlightRects(e)))))),R.U((e=>(0,l.zG)(e,n.c2,F.map((e=>e[e.length-1]))))))}_updateNativeCursor(){return L.h.combine(this._quasiCaretRect,this._assistantSession.view(F.isSome),((e,t)=>(0,l.zG)(s.Y(F.option)({nativeUIHider:F.fromNullable(this._params.integration.createNativeUIHider),quasiCaretRect:e}),F.filter((()=>t)),z.tapLeft((()=>{this._nativeCursorHider.modify((e=>((0,l.zG)(e,z.tap((e=>e.dispose()))),F.none)))})),z.tap((({nativeUIHider:e})=>{this._nativeCursorHider.modify((t=>((0,l.zG)(t,z.tap((e=>e.dispose()))),F.some(e()))))})))))}_terminateAssistantSession(e){this._assistantSession.modify(F.chain((t=>(t.dispose(e),F.none)))),e!==Le.R.closed&&e!==Le.R.assistantBlurred||this._params.integration.focusTextField()}_restartSession(){this._log.info("reconnecting checking service and restarting session"),(0,l.zG)(this._assistantSession.get(),z.tap((e=>{const t=e.sessionService.session.get().mode;var i;e.dispose(),this._assistantSession.set(F.none),(0,l.zG)(this._params.checkingService.get(),z.tap((e=>{e.reconnect()}))),i=t,ke.wR.isPushRewrite(i)?this._params.startNewSessionEvents.next({mode:ke.wR.ideation}):this._params.startNewSessionEvents.next({mode:t})})))}async _startNewAssistantSession(e){F.isSome(this._assistantSession.get())&&this._terminateAssistantSession(Le.R.disposed),this._assistantFocused.set(!0);const t=function(e,t,i,s){switch(e.mode){case Xe.wR.ideation:return{mode:e.mode,metadata:t,documentUrl:s};case Xe.wR.rewrite:case Xe.wR.quickRewrite:return{mode:e.mode,metadata:t};case Xe.wR.quickReply:return{mode:e.mode,quickReplyContext:(0,l.zG)(i,F.fold((()=>Xe.H3.empty),Je)),metadata:t};case Xe.wR.pushRewrite:return{mode:e.mode,writingExpertContext:e.writingExpertContext};default:(0,q.L0)(e)}}(e,{disableKnowledgeEngine:"disabled"===this._params.dapiSettings.get().serengetiState||void 0},this._params.integration.quickReplyContext.get(),this._params.url);e.mode===ke.wR.pushRewrite&&this._selectionRange.set(F.some(e.transformRange));const i=new Ee.Z({startSessionOptions:t,textEditorService:this._cheetahServices.textEditorService,capiService:this._cheetahServices.capiService,userService:this._cheetahServices.userService,trackingService:this._cheetahServices.trackingService,selectionContextAvailability:L.h.create({contextUpdatesClient:this._params.experimentClient.isGateEnabled(Qe.K.CheetahSelectionContextUpdates)&&"test"===this._params.experimentClient.getTreatment(Ye.p.CheetahSelectionContextUpdates),contextUpdatesServer:this._params.experimentClient.isGateEnabled(Qe.K.CheetahSelectionContextUpdatesServer)&&"test"===this._params.experimentClient.getTreatment(Ye.p.CheetahSelectionContextUpdates)})}),s=new Ue.p({capiService:this._cheetahServices.capiService}),{revisionEngine:n,dispose:o}=this._params.mergedCheetahEnabled?await tt({capiService:this._cheetahServices.capiService,domain:this._params.domain,getSessionUuid:()=>{var e,t;return null!==(t=null===(e=F.toNullable(this._params.checkingService.get()))||void 0===e?void 0:e.sessionUuid)&&void 0!==t?t:null},telemetry:this._params.telemetry}):{revisionEngine:void 0,dispose:l.Q1},r=De.s_.create({textEditorService:this._cheetahServices.textEditorService,userService:this._cheetahServices.userService,genAIAvailabilityService:this._cheetahServices.genAIAvailabilityService,trackingService:this._cheetahServices.trackingService,uphookService:this._cheetahServices.uphookService,feedbackService:this._cheetahServices.feedbackService,revisionEngine:n,sessionService:i,userSurveyService:s,positionInfo:this._params.integration.assistantPlacement.pipe(g.oA),handlers:{onFocusChange:e=>this._assistantFocused.set(e),close:()=>a.tD((()=>this._terminateAssistantSession(Le.R.closed)))}}),c=r.actions.subscribe((e=>this._cheetahServices.notifyAssistantUIAction(e))),d={sessionService:i,viewModels:r,dispose:()=>{o(),c.unsubscribe(),i.dispose(),s.dispose(),r.dispose(),this._assistantFocused.set(!1)}};this._assistantSession.set(F.some(d))}_getInlineButtonUI(){return(0,l.zG)(s.Y(r.P)({inlineButtonInfo:this._params.integration.inlineButtonPlacement,selectionRange:this._selectionRange,selectionOngoing:_.T(this._params.integration.selectionRange.pipe(R.U((e=>(0,l.zG)(e,F.isSome)))),this._params.integration.selectionRange.pipe(B.b(100),P.h(!1))),assistantClosed:this._assistantSession.view(F.isNone),textMapIsEmpty:this._params.integration.textMapIsEmpty,quickReplyContext:this._params.integration.quickReplyContext,availability:this._cheetahServices.genAIAvailabilityService.availability,entryPointsEnabled:this._entryPointsEnabled,featureFlags:this._params.featureFlags})).pipe(R.U((({inlineButtonInfo:e,selectionRange:t,selectionOngoing:i,assistantClosed:s,textMapIsEmpty:n,quickReplyContext:a,availability:o,entryPointsEnabled:r,featureFlags:d})=>(0,l.zG)(e,F.filter((()=>r)),F.filter((()=>s)),F.filter((()=>Te._.isUsable(o))),F.fold(l.gn,(e=>(0,l.zG)(t,F.fold(l.gn,(t=>n&&F.isSome(a)&&d.inlineQuickReply?c.createElement(he,{disabled:!1,referenceElement:e.referenceElement,placement:e.placement,offset:F.toNullable(e.offset),onClick:()=>{this._inlineButtonRecentlyPressed.set(!0),this._params.startNewSessionEvents.next({mode:ke.wR.quickReply})}}):ct(t)&&(d.inlineRewrite||d.magicRewrite)&&this._params.integration.enableInlineRewrites?c.createElement(pe,{disabled:i,referenceElement:e.referenceElement,placement:e.placement,offset:F.toNullable(e.offset),onOpenRewriteClick:d.inlineRewrite?()=>{this._inlineButtonRecentlyPressed.set(!0),this._params.startNewSessionEvents.next({mode:ke.wR.rewrite})}:void 0,onMagicRewriteClick:d.magicRewrite?()=>{this._inlineButtonRecentlyPressed.set(!0),this._params.startNewSessionEvents.next({mode:ke.wR.quickRewrite})}:void 0}):null)))))))))}_getAssistantUI(){return this._assistantSession.view(F.fold(l.gn,(e=>c.createElement(le,{isMac:this._params.isMac},Z.UI.mount((0,De.XR)(e.viewModels),(0,De.qA)(e.viewModels,{contentFlowOptions:{chatFlowOptions:{assistantMaxHeight:L.h.create(F.none)},feedbackFormFlowOptions:{showDomainCheckbox:F.some(this._params.domain)}}}))))))}_getOnboardingUI(){return this._onboardingViewModel.view(F.fold(l.gn,(e=>c.createElement(le,{isMac:this._params.isMac},Z.UI.mount(ze.gy,(0,ze.Bx)(e))))))}_getHighlightUI(){return L.h.combine(this._highlights,this._assistantSession.view(F.isSome),this._assistantFocused,((e,t,i)=>t&&i?e.map((({rect:e,visibility:t},i)=>c.createElement(Q,{key:`cheetah-highlight-rect-${i}`,top:e.top,left:e.left,width:e.width,height:e.height,visibility:t}))):null))}_getQuasiCaretUI(){return L.h.combine(this._quasiCaretRect,this._assistantSession.view(F.isSome),((e,t)=>(0,l.zG)(e,F.filter((()=>t)),F.fold((()=>null),(e=>c.createElement(Se,{left:e.left,top:e.top,height:e.height,overflow:this._params.integration.allowCustomCaretOverflow}))))))}_getIdeateButtonUI(){return L.h.combine(this._params.featureFlags,this._inlineButtonUI,this._selectionRange,this._params.integration.quickReplyContext,this._cheetahServices.genAIAvailabilityService.availability,this._entryPointsEnabled,((e,t,i,s,n,a)=>(0,l.zG)(t,F.fromPredicate((e=>null===e)),F.filter((()=>a&&e.ideateButton)),F.filter((()=>Te._.isUsable(n))),F.fold(l.gn,(()=>this._getIdeateButtonForSelectionRange(i,s,e))))))}_getExpandedIdeateButtonUI(){return this._params.mergedCheetahEnabled?L.h.create(null):L.h.combine(this._params.featureFlags,this._selectionRange,this._params.integration.quickReplyContext,this._cheetahServices.genAIAvailabilityService.availability,this._entryPointsEnabled,((e,t,i,s,n)=>(0,l.zG)(s,F.fromPredicate((e=>Te._.isVisible(e))),F.filter((()=>n&&e.ideateButton)),F.fold(l.gn,(()=>this._getIdeateButtonForSelectionRange(t,i,e))))))}_getIdeateButtonForSelectionRange(e,t,i){return this._params.mergedCheetahEnabled?null:(0,l.zG)(e,F.filter((e=>ct(e)&&i.rewrite)),F.fold((()=>rt(t)&&i.quickReply?ke.wR.quickReply:i.compose?ke.wR.ideation:null),(()=>ke.wR.rewrite)),F.fromNullable,F.fold(l.gn,(e=>c.createElement(it,{onMouseEnter:()=>this._ideateButtonRecentlyHovered.set(!0),onMouseLeave:()=>this._ideateButtonRecentlyHovered.set(!1),onClick:()=>this._onClickIdeateButton(e),mount:e=>this._ideateButtonRefChange.next(e),forceTooltipMessage:this._ideateButtonTooltipNotificationState.view(F.toUndefined)}))))}_insertText(e){""!==e?this._params.integration.insertText(e,this._selectionRange.get()):this._log.warn("insert() - attempting to insert empty response, skipping insert.")}dispose(){var e;this._disposed.next(null),this._terminateAssistantSession(Le.R.disposed),null===(e=F.toUndefined(this._onboardingViewModel.get()))||void 0===e||e.dispose(),this._cheetahServices.dispose(),this._subs.unsubscribe(),(0,l.zG)(this._nativeCursorHider.get(),z.tap((e=>e.dispose()))),this._params.integration.dispose()}}function rt(e){return(0,l.zG)(e,F.exists((e=>Object.values(e).filter((e=>void 0!==e)).length>0)))}function lt(e){return e.isConnected&&null!==e.offsetParent}function ct(e){const t=e.end-e.start;return t>=10&&t<5e3}function dt(e){return(0,D.W9)(Pe.l.is(Pe.l.Kind.mount),(e=>e.step===Oe.T.StepName.initial))(e)}function ht(e){return(0,D.W9)(Pe.l.is(Pe.l.Kind.mount),(e=>e.step===Oe.T.StepName.initialBTS))(e)}},88571:(e,t,i)=>{i.d(t,{Q:()=>l});var s=i(27378),n=i(15073),a=i(60797),o=i(95300),r=i(5114);const l=({children:e,remSize:t,setter:i})=>(c+=1,s.useEffect((()=>{const e=t.subscribe((e=>{d.next(r.some(e)),i(r.some(e))}));return()=>{e.unsubscribe(),c-=1,0===c&&(d.next(r.none),i(r.none))}}),[t]),s.createElement(n.u.Context.Provider,{value:d.pipe(a.oA)},e));let c=0;const d=new o.X(r.none)},51325:e=>{e.exports={highlightRect:"XWxTA",hidden:"o979x",attention:"bHjcD",blink:"oy7wj"}},16805:e=>{e.exports={ideateButton:"_ErYR",ideateButtonIcon:"i8HXG",spin:"CSZH1"}},87491:e=>{e.exports={entryButton:"cDocn",entryButtonItem:"dJCJe",rewriteIcon:"wGNWN",openIcon:"vIUqu",spin:"A8MjA"}},50783:e=>{e.exports={replyButton:"ZfD1U",icon:"BdxRh",spin:"MBS28"}},48033:e=>{e.exports={quasiCaret:"WhbAl",icon:"Yd_W5"}}}]);